#!/usr/bin/env node
// Pre-commit hook to validate backend JavaScript files
const { execSync } = require('child_process');
const path = require('path');
const fs = require('fs');

const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function checkSyntax(filePath) {
  try {
    execSync(`node --check "${filePath}"`, { stdio: 'pipe' });
    return true;
  } catch (error) {
    return false;
  }
}

function getStagedFiles() {
  try {
    const output = execSync('git diff --cached --name-only --diff-filter=ACM', { encoding: 'utf-8' });
    return output.trim().split('\n').filter(Boolean);
  } catch (error) {
    return [];
  }
}

function main() {
  log('\nüîç Running pre-commit checks...\n', 'blue');

  const stagedFiles = getStagedFiles();
  const jsFiles = stagedFiles.filter(f => f.endsWith('.js') && (f.startsWith('backend/') || f.startsWith('src/')));

  if (jsFiles.length === 0) {
    log('‚úÖ No JavaScript files to check\n', 'green');
    process.exit(0);
  }

  log(`Checking ${jsFiles.length} JavaScript file(s)...\n`, 'blue');

  let hasErrors = false;

  for (const file of jsFiles) {
    if (!fs.existsSync(file)) {
      log(`‚ö†Ô∏è  Skipped (file not found): ${file}`, 'yellow');
      continue;
    }

    process.stdout.write(`  ‚óº ${file}... `);

    if (checkSyntax(file)) {
      log('‚úì', 'green');
    } else {
      log('‚úó', 'red');
      log(`    Syntax error detected in ${file}`, 'red');
      hasErrors = true;
    }
  }

  console.log('');

  if (hasErrors) {
    log('\n‚ùå Pre-commit checks failed. Commit aborted.\n', 'red');
    log('Fix the syntax errors and try again.\n', 'yellow');
    process.exit(1);
  }

  log('‚úÖ All checks passed!\n', 'green');
  process.exit(0);
}

main();

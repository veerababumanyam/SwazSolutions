# vCard Template System - Phase 4

Complete backend infrastructure for the vCard template system. Includes database schema, REST API, services, seed data, and thumbnail generation.

## Overview

The template system allows users to:
- Browse 15 pre-built professional templates across 5 categories
- Preview templates with generated HTML
- Apply templates to profiles (replace, merge, or theme-only modes)
- Create custom templates from existing profiles
- Manage personal template collection (public/private)
- Track template usage and popularity

## Architecture

### Database Schema

Two new tables added to SQLite:

#### `vcard_templates`
Stores template configurations with JSON serialization for complex objects:
- `id` - Primary key
- `name` - Template name
- `description` - Template description
- `category` - One of: Professional, Creative, Business, Hospitality, Technical
- `thumbnail` - URL to SVG preview thumbnail
- `theme_config` - JSON: colors, typography, layout settings
- `blocks_config` - JSON: array of block configurations
- `social_profiles_config` - JSON: array of suggested social platforms
- `is_system` - Boolean: system template (can't delete)
- `is_ai_generated` - Boolean: generated by AI
- `tags` - Comma-separated search tags
- `popularity` - Usage count (incremented when applied)
- `created_by` - User ID (null for system templates)
- `is_public` - Boolean: public for other users (user-created only)
- `created_at`, `updated_at` - Timestamps

Indexes:
- `idx_vcard_templates_category` - Fast filtering by category
- `idx_vcard_templates_is_system` - System template queries
- `idx_vcard_templates_tags` - Search by tags
- `idx_vcard_templates_created_by` - User's templates

#### `template_usage`
Tracks which profiles use which templates:
- `id` - Primary key
- `template_id` - FK to vcard_templates
- `profile_id` - FK to profiles
- `applied_at` - Application timestamp
- `apply_mode` - 'replace', 'merge', or 'theme-only'

Indexes:
- `idx_template_usage_template` - Find templates' usage
- `idx_template_usage_profile` - Find profile's applied templates
- `idx_template_usage_applied` - Timeline queries

### REST API

Base endpoint: `/api/templates`

#### Public Endpoints (No Auth Required)

**GET /api/templates** - List templates
```javascript
Query Parameters:
- category: string (Professional, Creative, Business, Hospitality, Technical)
- tags: string (comma-separated search tags)
- search: string (search by name/description)
- limit: number (1-100, default 20)
- offset: number (pagination, default 0)
- sortBy: string (popular, newest, oldest, name)

Response:
{
  "templates": [{
    "id": 1,
    "name": "Corporate Executive",
    "description": "...",
    "category": "Professional",
    "thumbnail": "/thumbnails/template-1-corporate-executive.svg",
    "is_system": 1,
    "tags": "corporate,executive,formal,professional,dark",
    "popularity": 42,
    "created_at": "2026-01-31T00:00:00Z"
  }],
  "total": 15,
  "limit": 20,
  "offset": 0
}
```

**GET /api/templates/:id** - Get template details
```javascript
Response:
{
  "id": 1,
  "name": "Corporate Executive",
  "description": "...",
  "category": "Professional",
  "theme_config": {
    "colors": {
      "primary": "#1F2937",
      "secondary": "#3B82F6",
      "background": "#FFFFFF",
      "text": "#111827"
    },
    "typography": {
      "fontFamily": "Georgia, serif",
      "headingSize": 36,
      "bodySize": 14
    },
    "layout": {
      "style": "corporate",
      "spacing": "comfortable",
      "borderRadius": 4
    }
  },
  "blocks_config": [
    {
      "type": "TEXT",
      "title": "Professional Bio",
      "displayOrder": 1
    },
    {
      "type": "LINK",
      "title": "LinkedIn Profile",
      "url": "https://linkedin.com",
      "displayOrder": 2
    }
  ],
  "social_profiles_config": [
    { "platform": "LinkedIn", "displayOrder": 1 },
    { "platform": "Twitter", "displayOrder": 2 }
  ]
}
```

**GET /api/templates/:id/preview** - HTML preview
```javascript
Returns: HTML string with SVG-based template preview
Content-Type: text/html
Status: 200
```

**GET /api/templates/categories** - Get categories with counts
```javascript
Response:
{
  "categories": [
    { "category": "Professional", "count": 5 },
    { "category": "Creative", "count": 5 },
    { "category": "Business", "count": 2 },
    { "category": "Hospitality", "count": 2 },
    { "category": "Technical", "count": 1 }
  ]
}
```

#### Protected Endpoints (Auth Required)

**POST /api/templates/:id/apply** - Apply template to profile
```javascript
Body:
{
  "profileId": 1,
  "mode": "replace" | "merge" | "theme-only"
}

Response:
{
  "success": true,
  "appliedTemplate": { ...full template object... },
  "changes": {
    "appliedAt": "2026-01-31T12:00:00Z",
    "mode": "replace",
    "previousState": { "blocks": [...] },
    "newState": {
      "blocks": [...],
      "theme": { ...theme object... }
    }
  }
}

Error Responses:
- 403: Profile not found or permission denied
- 404: Template not found
- 400: Invalid apply mode
```

**POST /api/templates** - Create custom template from profile
```javascript
Body:
{
  "profileId": 1,
  "name": "My Custom Template",
  "description": "A custom template I created",
  "category": "Professional",
  "tags": "custom,professional",
  "isPublic": false
}

Response: Full template object with new ID
Status: 201 Created

Validation:
- profileId required
- name required, non-empty
- category required, valid category
- All profile settings captured as template
```

**POST /api/templates/:id/duplicate** - Duplicate system template
```javascript
Body:
{
  "newName": "My Corporate Executive Copy"
}

Response: New custom template object
Status: 201 Created
```

**PUT /api/templates/:id** - Update custom template (owner only)
```javascript
Body: Partial template object
{
  "name": "Updated Name",
  "description": "Updated description",
  "category": "Creative",
  "tags": "updated,creative",
  "isPublic": true
}

Note: Cannot update theme or blocks directly (immutable)
Response: Updated template object
```

**DELETE /api/templates/:id** - Delete custom template (owner only)
```javascript
Response:
{
  "success": true,
  "message": "Template deleted"
}

Errors:
- 403: Cannot delete system templates
- 404: Template not found or permission denied
```

**GET /api/templates/user/my-templates** - Get user's templates
```javascript
Query Parameters:
- limit: number (default 20)
- offset: number (default 0)

Response:
{
  "templates": [{ ...user template objects... }],
  "total": 3,
  "limit": 20,
  "offset": 0
}
```

## Service Layer

### `templateService.js`

Core business logic for template operations:

#### Functions

**validateTemplate(template)**
- Validates template structure and required fields
- Returns: `{ valid: boolean, errors: string[] }`

**getTemplateWithConfig(templateId)**
- Fetches template and parses JSON configurations
- Returns: Complete template object with resolved configs

**listTemplates(options)**
- Filters and paginates templates
- Options: category, tags, search, limit, offset, sortBy
- Returns: `{ templates: [], total: number }`

**getTemplateCategories()**
- Returns array of categories with counts

**createTemplateFromProfile(profileId, userId, templateData)**
- Creates custom template from user's profile
- Captures theme, blocks, and social links
- Returns: New template object

**applyTemplate(templateId, profileId, userId, mode, options)**
- Applies template to profile with three modes:
  - `replace`: Clear blocks, apply template
  - `merge`: Keep existing, add new block types
  - `theme-only`: Update theme only
- Records usage in template_usage table
- Increments popularity counter
- Returns: `{ success, appliedTemplate, changes }`

**duplicateTemplate(templateId, userId, newName)**
- Creates user-owned copy of system/public template
- Returns: New template object

**updateTemplate(templateId, userId, updates)**
- Updates allowed fields: name, description, category, tags, is_public
- Theme/blocks are immutable
- Returns: Updated template object

**deleteTemplate(templateId, userId)**
- Deletes custom user template
- Prevents deletion of system templates
- Returns: true if successful

**generateTemplatePreview(template)**
- Creates HTML preview with SVG visualization
- Shows header, sample blocks, color palette
- Returns: HTML string

## Seed Data

### 15 System Templates

**Professional Category (5):**
1. **Corporate Executive** - Dark, formal, credibility-focused
2. **Lawyer/Consultant** - Navy, credentials-heavy, trust indicators
3. **Financial Professional** - Green, trustworthy, advisor-oriented
4. **Medical Professional** - Blue, healthcare-focused, caring
5. **Academic Professional** - Purple, research-oriented, publications

**Creative Category (5):**
1. **Photographer Portfolio** - Black, gallery-focused, minimal
2. **Artist Creative Profile** - Pink, vibrant, artistic
3. **Music Producer/DJ** - Purple/Pink, high-energy, streaming-focused
4. **Writer/Author** - Warm, literary, content-focused
5. **Content Creator/Influencer** - Red, vibrant, multi-platform

**Business Category (2):**
1. **Startup/Entrepreneur** - Blue, modern, pitch-ready
2. **E-Commerce Business** - Green, sales-focused, commerce

**Hospitality Category (2):**
1. **Restaurant/Cafe** - Warm, appetizing, reservation-focused
2. **Hotel/Accommodation** - Deep blue, luxury, booking-focused

**Technical Category (1):**
1. **Developer/Tech Professional** - Dark, code-focused, portfolio-ready

Each template includes:
- Professional theme (colors, typography, layout)
- 4-5 pre-configured blocks (TEXT, LINK, CONTACT_FORM, MAP_LOCATION)
- Suggested social profile platforms
- Category and search tags
- Descriptive name and description

### Seeding Process

Auto-runs on server startup (4000ms delay):

1. **Check existing templates** - Count system templates
2. **Seed templates** - Insert any missing templates
3. **Generate thumbnails** - Create SVG previews for all templates

Manual seeding available:
```bash
node backend/scripts/seed-templates.js
```

## Thumbnail Service

### `templateThumbnailService.js`

Generates SVG thumbnails for visual preview:

**Features:**
- SVG-based (no external dependencies)
- Shows header with theme colors
- Displays sample blocks with accent colors
- Color palette preview
- Responsive sizing (300x400px)

**Functions:**

**generateSVGThumbnail(template)**
- Creates SVG string from template config
- Shows theme colors and sample blocks

**generateThumbnail(template, templateId)**
- Generates and saves SVG to `/public/thumbnails/`
- Returns URL: `/thumbnails/template-{id}-{name}.svg`

**generateThumbnailsForAll(db, templates)**
- Batch generates all thumbnails
- Updates database with thumbnail URLs
- Returns: `{ successful: number, failed: number }`

**Initialization:**
- Creates placeholder thumbnail on startup
- Auto-called during template seeding

## Frontend Integration

### API Client Usage

```typescript
// List templates
const { templates, total } = await fetch('/api/templates?category=Professional')
  .then(r => r.json());

// Get template details
const template = await fetch(`/api/templates/${id}`).then(r => r.json());

// Preview
const html = await fetch(`/api/templates/${id}/preview`)
  .then(r => r.text());

// Apply template (requires auth)
const result = await fetch(`/api/templates/${id}/apply`, {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({ profileId: 1, mode: 'replace' })
}).then(r => r.json());

// Create custom template (requires auth)
const newTemplate = await fetch('/api/templates', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({
    profileId: 1,
    name: 'My Template',
    category: 'Professional',
    isPublic: false
  })
}).then(r => r.json());

// Get user templates (requires auth)
const { templates } = await fetch('/api/templates/user/my-templates', {
  headers: { 'Authorization': `Bearer ${token}` }
}).then(r => r.json());
```

## Apply Modes Explained

**Replace Mode** (Default)
- Deletes all existing blocks
- Applies all template blocks
- Applies template theme
- Use: Complete redesign with template

**Merge Mode**
- Keeps existing blocks
- Adds new block types not already present
- Applies template theme
- Use: Enhance with new features

**Theme-Only Mode**
- Keeps all existing blocks
- Only updates theme (colors, typography, layout)
- Use: Quick style refresh

## Performance Considerations

**Database Queries:**
- Pagination: limit 1-100 (default 20)
- Indexes on category, is_system, tags, created_by
- Composite indexes for common queries

**Thumbnails:**
- SVG format (lightweight, scalable)
- Cached in `/public/thumbnails/`
- Served statically (fast)

**Template Configs:**
- JSON serialization for flexibility
- Parsed on retrieval (memory-efficient storage)
- Shallow copies for theme-only mode (reduces I/O)

## Error Handling

**Validation:**
- Required field checks (name, category, profileId)
- Category enum validation
- JSON structure validation
- Permission checks (ownership, system template protection)

**Responses:**
- 400: Invalid input (validation failed)
- 403: Permission denied (not owner, system template)
- 404: Not found (template, profile)
- 500: Server error (logged with stack trace)

**Service Level:**
- Try-catch blocks on all operations
- Detailed error messages
- Stack trace logging
- Transaction-safe database operations

## Monitoring & Analytics

**Tracking:**
- Template usage recorded in `template_usage` table
- Popularity counter increments on apply
- Applied mode tracked (replace/merge/theme-only)
- Timestamps for usage analytics

**Metrics:**
- Most popular templates (by apply count)
- Usage by category
- Template application timeline
- Adoption rates

## File Structure

```
backend/
├── config/
│   └── database.js          (Schema additions for Phase 4)
├── routes/
│   └── templates.js         (REST API routes)
├── services/
│   ├── templateService.js   (Core business logic)
│   └── templateThumbnailService.js (SVG generation)
├── data/
│   └── template-definitions.js (15 system templates)
├── scripts/
│   └── seed-templates.js    (Manual seeding script)
├── public/
│   └── thumbnails/          (Generated SVG previews)
└── TEMPLATE_SYSTEM.md       (This documentation)
```

## Testing Checklist

- [ ] List templates (no auth)
- [ ] Filter by category
- [ ] Search by name/tags
- [ ] Pagination (limit/offset)
- [ ] Get template details (public)
- [ ] Generate HTML preview
- [ ] Apply template (replace mode)
- [ ] Apply template (merge mode)
- [ ] Apply template (theme-only mode)
- [ ] Create custom template
- [ ] Update custom template
- [ ] Delete custom template
- [ ] Duplicate system template
- [ ] Permission checks (403 errors)
- [ ] Template not found (404)
- [ ] Invalid parameters (400)
- [ ] Database seeding (15 templates)
- [ ] Thumbnail generation
- [ ] Static thumbnail serving

## Future Enhancements

1. **Template Marketplace**
   - User-created templates available for purchase
   - Rating and review system
   - Featured templates section

2. **AI Template Generation**
   - Generate templates from user preferences
   - Style recommendations based on content
   - Personalization suggestions

3. **Template Variations**
   - Color scheme variants
   - Dark/light mode options
   - Responsive layout variants

4. **Advanced Analytics**
   - A/B testing templates
   - Conversion tracking
   - Engagement metrics per template

5. **Template Sharing**
   - Share templates with team members
   - Collaborative template design
   - Template versioning

## References

- Database: `backend/config/database.js`
- Routes: `backend/routes/templates.js`
- Services: `backend/services/templateService.js`
- Thumbnails: `backend/services/templateThumbnailService.js`
- Seed Data: `backend/data/template-definitions.js`
- Seed Script: `backend/scripts/seed-templates.js`
